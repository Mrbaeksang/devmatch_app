import { NextResponse } from 'next/server';
import { getServerSession } from 'next-auth';
import { authOptions } from '@/lib/auth';
import { db } from '@/lib/db';

export async function GET(
  req: Request,
  { params }: { params: Promise<{ projectId: string }> }
) {
  try {
    const session = await getServerSession(authOptions);
    
    const { projectId } = await params;

    // í”„ë¡œì íŠ¸ IDë¡œ í”„ë¡œì íŠ¸ ì°¾ê¸°
    const project = await db.project.findUnique({
      where: { id: projectId },
      include: {
        members: {
          include: {
            user: {
              select: {
                id: true,
                name: true,
                email: true,
                avatar: true,
                nickname: true
              }
            }
          }
        }
      }
    });

    if (!project) {
      return NextResponse.json({ message: 'í”„ë¡œì íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, { status: 404 });
    }

    // í˜„ì¬ ì‚¬ìš©ì ì°¾ê¸°
    let currentUser = null;
    if (session?.user?.id) {
      currentUser = project.members.find(m => m.user.id === session.user.id);
    }

    // íŒ€ì› ì •ë³´ ë³€í™˜
    const members = project.members.map(member => ({
      id: member.id,
      name: member.user.nickname || member.user.name,
      avatar: member.user.avatar,
      joinedAt: member.joinedAt,
      userId: member.user.id,
      interviewStatus: member.interviewStatus,
      canStartInterview: member.interviewStatus === 'PENDING',
      memberProfile: member.memberProfile,
      role: member.role
    }));

    // í”„ë¡œì íŠ¸ ì •ë³´ ë°˜í™˜
    const projectData = {
      id: project.id,
      name: project.name,
      description: project.description,
      status: project.status,
      inviteCode: project.inviteCode,
      teamSize: project.teamSize,
      techStack: project.techStack,
      blueprint: project.blueprint,
      teamAnalysis: project.teamAnalysis,
      members: members,
      createdAt: project.createdAt
    };

    // í˜„ì¬ ì‚¬ìš©ì ì •ë³´ ë³€í™˜
    let currentUserData = null;
    if (currentUser) {
      currentUserData = {
        id: currentUser.id,
        name: currentUser.user.nickname || currentUser.user.name,
        avatar: currentUser.user.avatar,
        joinedAt: currentUser.joinedAt,
        userId: currentUser.user.id,
        interviewStatus: currentUser.interviewStatus,
        canStartInterview: currentUser.interviewStatus === 'PENDING',
        memberProfile: currentUser.memberProfile,
        role: currentUser.role,
        user: currentUser.user
      };
    }

    return NextResponse.json({
      project: projectData,
      currentUser: currentUserData,
      isUserInProject: !!currentUser
    });

  } catch (error) {
    console.error('í”„ë¡œì íŠ¸ ì¡°íšŒ ì˜¤ë¥˜:', error);
    
    return NextResponse.json(
      { 
        message: 'í”„ë¡œì íŠ¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
        error: process.env.NODE_ENV === 'development' ? (error as Error).message : undefined 
      },
      { status: 500 }
    );
  }
}

export async function POST(
  req: Request,
  { params }: { params: Promise<{ projectId: string }> }
) {
  try {
    const session = await getServerSession(authOptions);
    if (!session?.user?.id) {
      return NextResponse.json({ message: 'Unauthorized' }, { status: 401 });
    }

    const { projectId } = await params;

    // í”„ë¡œì íŠ¸ IDë¡œ í”„ë¡œì íŠ¸ ì°¾ê¸°
    const project = await db.project.findUnique({
      where: { id: projectId },
      include: {
        members: true
      }
    });

    if (!project) {
      return NextResponse.json({ message: 'í”„ë¡œì íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' }, { status: 404 });
    }

    // ì´ë¯¸ ì°¸ì—¬í•œ ì‚¬ìš©ìì¸ì§€ í™•ì¸
    const existingMember = project.members.find(m => m.userId === session.user.id);
    if (existingMember) {
      return NextResponse.json({ message: 'ì´ë¯¸ ì°¸ì—¬í•œ í”„ë¡œì íŠ¸ì…ë‹ˆë‹¤.' }, { status: 400 });
    }

    // ìµœëŒ€ ì¸ì› í™•ì¸
    if (project.members.length >= project.teamSize) {
      return NextResponse.json({ message: 'í”„ë¡œì íŠ¸ê°€ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤.' }, { status: 400 });
    }

    // ë©¤ë²„ ì¶”ê°€
    const newMember = await db.projectMember.create({
      data: {
        projectId: project.id,
        userId: session.user.id,
        interviewStatus: 'PENDING'
      },
      include: {
        user: {
          select: {
            name: true,
            nickname: true
          }
        }
      }
    });

    // í”„ë¡œì íŠ¸ê°€ ACTIVE ìƒíƒœì¸ ê²½ìš° ì‹œìŠ¤í…œ ë©”ì‹œì§€ ì¶”ê°€
    if (project.status === 'ACTIVE') {
      const memberName = newMember.user.nickname || newMember.user.name;
      await db.chatMessage.create({
        data: {
          projectId: project.id,
          content: `${memberName}ë‹˜ì´ íŒ€ì— ì°¸ì—¬í–ˆìŠµë‹ˆë‹¤! ğŸ‰`,
          type: 'SYSTEM'
        }
      });
    }

    return NextResponse.json({ message: 'í”„ë¡œì íŠ¸ì— ì°¸ì—¬í–ˆìŠµë‹ˆë‹¤.' });

  } catch (error) {
    console.error('í”„ë¡œì íŠ¸ ì°¸ì—¬ ì˜¤ë¥˜:', error);
    
    return NextResponse.json(
      { 
        message: 'í”„ë¡œì íŠ¸ ì°¸ì—¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
        error: process.env.NODE_ENV === 'development' ? (error as Error).message : undefined 
      },
      { status: 500 }
    );
  }
}