#!/bin/bash

# DevMatch ν”„λ΅μ νΈ κ°λ° μ „ μλ™ κ²€μ‚¬ ν›…
# CLAUDE.mdμ μ²΄ν¬λ¦¬μ¤νΈλ¥Ό μλ™ν™”

echo "π€ DevMatch κ°λ° μ „ μλ™ κ²€μ‚¬ μ‹μ‘..."
echo "β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”"

# 1. ESLint κ²€μ‚¬
echo "π“‹ 1. ESLint μ½”λ“ ν’μ§ κ²€μ‚¬..."
if ! pnpm lint --fix; then
    echo "β ESLint κ²€μ‚¬ μ‹¤ν¨ - μ½”λ“ μμ • ν›„ λ‹¤μ‹ μ‹λ„ν•μ„Έμ”."
    exit 1
fi
echo "β… ESLint κ²€μ‚¬ ν†µκ³Ό"

# 2. TypeScript νƒ€μ… κ²€μ‚¬
echo "π“‹ 2. TypeScript νƒ€μ… κ²€μ‚¬..."
if ! pnpm typecheck; then
    echo "β TypeScript νƒ€μ… κ²€μ‚¬ μ‹¤ν¨ - νƒ€μ… μ¤λ¥λ¥Ό μμ •ν•μ„Έμ”."
    exit 1
fi
echo "β… TypeScript νƒ€μ… κ²€μ‚¬ ν†µκ³Ό"

# 3. ν”„λ΅λ•μ… λΉλ“ ν…μ¤νΈ
echo "π“‹ 3. ν”„λ΅λ•μ… λΉλ“ ν…μ¤νΈ..."
if ! pnpm build; then
    echo "β λΉλ“ μ‹¤ν¨ - λΉλ“ μ¤λ¥λ¥Ό μμ •ν•μ„Έμ”."
    exit 1
fi
echo "β… λΉλ“ ν…μ¤νΈ ν†µκ³Ό"

# 4. Prisma μ¤ν‚¤λ§ κ²€μ¦
echo "π“‹ 4. Prisma μ¤ν‚¤λ§ κ²€μ¦..."
if ! pnpm prisma validate; then
    echo "β Prisma μ¤ν‚¤λ§ μ¤λ¥ - μ¤ν‚¤λ§λ¥Ό ν™•μΈν•μ„Έμ”."
    exit 1
fi
echo "β… Prisma μ¤ν‚¤λ§ κ²€μ¦ ν†µκ³Ό"

# 5. μ£Όμ” νμΌ κµ¬μ΅° κ²€μ‚¬
echo "π“‹ 5. ν”„λ΅μ νΈ κµ¬μ΅° κ²€μ‚¬..."

# ν•„μ λ””λ ‰ν† λ¦¬ ν™•μΈ
required_dirs=("app" "components" "lib" "types" "prisma")
for dir in "${required_dirs[@]}"; do
    if [ ! -d "$dir" ]; then
        echo "β ν•„μ λ””λ ‰ν† λ¦¬ '$dir'κ°€ μ—†μµλ‹λ‹¤."
        exit 1
    fi
done

# ν•„μ νμΌ ν™•μΈ
required_files=("CLAUDE.md" "package.json" "tsconfig.json" "prisma/schema.prisma")
for file in "${required_files[@]}"; do
    if [ ! -f "$file" ]; then
        echo "β ν•„μ νμΌ '$file'μ΄ μ—†μµλ‹λ‹¤."
        exit 1
    fi
done

echo "β… ν”„λ΅μ νΈ κµ¬μ΅° κ²€μ‚¬ ν†µκ³Ό"

# 6. ν™κ²½ λ³€μ κ²€μ‚¬
echo "π“‹ 6. ν™κ²½ λ³€μ κ²€μ‚¬..."
if [ ! -f ".env" ] && [ ! -f ".env.local" ]; then
    echo "β ν™κ²½ λ³€μ νμΌ(.env λλ” .env.local)μ΄ μ—†μµλ‹λ‹¤."
    exit 1
fi

# ν•„μ ν™κ²½ λ³€μ ν™•μΈ
required_env_vars=("DATABASE_URL" "NEXTAUTH_SECRET" "NEXTAUTH_URL")
missing_vars=()

for var in "${required_env_vars[@]}"; do
    if [ -z "${!var}" ]; then
        # .env νμΌμ—μ„ ν™•μΈ
        if [ -f ".env" ] && ! grep -q "^$var=" .env; then
            if [ -f ".env.local" ] && ! grep -q "^$var=" .env.local; then
                missing_vars+=("$var")
            fi
        fi
    fi
done

if [ ${#missing_vars[@]} -ne 0 ]; then
    echo "β λ„λ½λ ν™κ²½ λ³€μ: ${missing_vars[*]}"
    echo "   .env λλ” .env.local νμΌμ— λ‹¤μ λ³€μλ“¤μ„ μ„¤μ •ν•μ„Έμ”:"
    for var in "${missing_vars[@]}"; do
        echo "   - $var"
    done
    exit 1
fi

echo "β… ν™κ²½ λ³€μ κ²€μ‚¬ ν†µκ³Ό"

echo "β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”"
echo "π‰ λ¨λ“  κ²€μ‚¬ ν†µκ³Ό! κ°λ°μ„ μ‹μ‘ν•  μ¤€λΉ„κ°€ λμ—μµλ‹λ‹¤."
echo ""
echo "π“ CLAUDE.md κ°€μ΄λ“ μ¤€μ μ‚¬ν•­:"
echo "   β… λ¨λ“  μ½”λ“μ— μƒμ„Έν• μ£Όμ„ ν•„μ"
echo "   β… μƒλ΅μ΄ κ°λ… λ“±μ¥ μ‹ κ°„λ‹¨ μ„¤λ… ν¬ν•¨"
echo "   β… νƒ€μ… μ•μ •μ„± ν™•λ³΄ (any νƒ€μ… κΈμ§€)"
echo "   β… Next.js 15 ν‘μ¤€ κµ¬μ΅° μ¤€μ"
echo "   β… μ»΄ν¬λ„νΈ μ¬μ‚¬μ© μ°μ„ "
echo ""
echo "π”§ κ°λ° λ…λ Ήμ–΄:"
echo "   pnpm dev         - κ°λ° μ„λ²„ μ‹μ‘"
echo "   pnpm build       - ν”„λ΅λ•μ… λΉλ“"
echo "   pnpm lint        - ESLint κ²€μ‚¬"
echo "   pnpm typecheck   - νƒ€μ… κ²€μ‚¬"
echo "   pnpm prisma studio - DB κ΄€λ¦¬"
echo ""